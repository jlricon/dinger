<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#0d0d0d">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="manifest" href="manifest.json">
<title>Dinger</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500&display=swap');

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    background: #0d0d0d;
    color: #a0a0a0;
    min-height: 100dvh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 2rem 1rem;
    -webkit-font-smoothing: antialiased;
  }

  .container {
    width: 100%;
    max-width: 320px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2.5rem;
  }

  h1 {
    font-size: 1rem;
    font-weight: 300;
    letter-spacing: 0.3em;
    text-transform: uppercase;
    color: #555;
  }

  /* --- Countdown --- */
  #countdown {
    font-size: 3.5rem;
    font-weight: 300;
    color: #e8e8e8;
    font-variant-numeric: tabular-nums;
    min-height: 4rem;
    letter-spacing: 0.02em;
  }

  #countdown:empty::after {
    content: "\00b7";
    color: #333;
  }

  /* --- Sound selector --- */
  .sound-row {
    display: flex;
    gap: 1.5rem;
  }

  .sound-btn {
    background: none;
    border: none;
    color: #444;
    font-family: inherit;
    font-size: 0.8rem;
    font-weight: 400;
    letter-spacing: 0.05em;
    cursor: pointer;
    padding: 0.4rem 0;
    border-bottom: 1px solid transparent;
    transition: color 0.2s, border-color 0.2s;
  }

  .sound-btn:hover { color: #888; }
  .sound-btn.selected {
    color: #c0c0c0;
    border-bottom-color: #c0c0c0;
  }

  /* --- Interval --- */
  .interval-row {
    display: flex;
    align-items: baseline;
    gap: 0.5rem;
  }

  .interval-row input {
    background: none;
    border: none;
    border-bottom: 1px solid #333;
    color: #e8e8e8;
    font-family: inherit;
    font-size: 1.5rem;
    font-weight: 300;
    width: 3rem;
    text-align: center;
    padding: 0.25rem 0;
    outline: none;
    transition: border-color 0.2s;
  }

  .interval-row input:focus {
    border-bottom-color: #666;
  }

  .interval-row span {
    font-size: 0.85rem;
    color: #555;
    font-weight: 300;
  }

  /* --- Controls --- */
  .controls {
    display: flex;
    gap: 2rem;
  }

  .ctrl-btn {
    background: none;
    border: 1px solid #333;
    color: #888;
    font-family: inherit;
    font-size: 0.8rem;
    font-weight: 400;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    padding: 0.6rem 1.8rem;
    border-radius: 2rem;
    cursor: pointer;
    transition: color 0.2s, border-color 0.2s;
  }

  .ctrl-btn:hover:not(:disabled) {
    color: #e8e8e8;
    border-color: #666;
  }

  .ctrl-btn:disabled {
    opacity: 0.25;
    cursor: default;
  }

  /* --- Status --- */
  #status {
    font-size: 0.75rem;
    color: #444;
    text-align: center;
    min-height: 1.2em;
    font-weight: 300;
    letter-spacing: 0.03em;
  }
</style>
</head>
<body>

<div class="container">
  <h1>Dinger</h1>

  <div id="countdown"></div>

  <div class="sound-row">
    <button class="sound-btn" data-sound="bell">Bell</button>
    <button class="sound-btn" data-sound="bowl">Singing Bowl</button>
  </div>

  <div class="interval-row">
    <input type="number" id="interval" min="1" step="1" value="5">
    <span>min</span>
  </div>

  <div class="controls">
    <button class="ctrl-btn" id="startBtn">Start</button>
    <button class="ctrl-btn" id="stopBtn" disabled>Stop</button>
  </div>

  <div id="status"></div>
</div>

<audio id="audio-bell" preload="auto" src="140128__jetrye__bell-meditation_cleaned.wav"></audio>
<audio id="audio-bowl" preload="auto" src="freesound_community-singing-bowl-hit-3-33366.mp3"></audio>

<script>
const SOUNDS = {
  bell: { label: "Bell", el: document.getElementById("audio-bell") },
  bowl: { label: "Singing Bowl", el: document.getElementById("audio-bowl") },
};

let selectedSound = localStorage.getItem("dinger-sound") || "bell";
let swRegistration = null;

// --- Service Worker ---
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js").then(reg => {
    swRegistration = reg;
  });
}

// --- Restore interval ---
const intervalInput = document.getElementById("interval");
const savedInterval = localStorage.getItem("dinger-interval");
if (savedInterval) intervalInput.value = savedInterval;

intervalInput.addEventListener("change", () => {
  localStorage.setItem("dinger-interval", intervalInput.value);
});

function playSound() {
  const audio = SOUNDS[selectedSound].el;
  audio.currentTime = 0;
  audio.play();
}

function selectSound(key) {
  selectedSound = key;
  localStorage.setItem("dinger-sound", key);
  document.querySelectorAll(".sound-btn").forEach(b => {
    b.classList.toggle("selected", b.dataset.sound === key);
  });
}

function showNotification() {
  if (!swRegistration || Notification.permission !== "granted") return;
  swRegistration.showNotification("Dinger", {
    body: SOUNDS[selectedSound].label,
    tag: "dinger-bell",
    vibrate: [200, 100, 200],
    renotify: true,
  });
}

// --- Silent audio keepalive (prevents mobile browsers from suspending JS) ---
let keepaliveCtx = null;
let keepaliveSource = null;

function startKeepalive() {
  keepaliveCtx = new (window.AudioContext || window.webkitAudioContext)();
  // 1-second silent buffer looping forever
  const buf = keepaliveCtx.createBuffer(1, keepaliveCtx.sampleRate, keepaliveCtx.sampleRate);
  keepaliveSource = keepaliveCtx.createBufferSource();
  keepaliveSource.buffer = buf;
  keepaliveSource.loop = true;
  // Connect through a near-zero gain so it's inaudible
  const gain = keepaliveCtx.createGain();
  gain.gain.value = 0.001;
  keepaliveSource.connect(gain);
  gain.connect(keepaliveCtx.destination);
  keepaliveSource.start();
}

function stopKeepalive() {
  if (keepaliveSource) { keepaliveSource.stop(); keepaliveSource = null; }
  if (keepaliveCtx) { keepaliveCtx.close(); keepaliveCtx = null; }
}

// --- UI ---
let timerId = null;
let countdownId = null;
let nextDing = null;
let intervalMs = null;

const startBtn = document.getElementById("startBtn");
const stopBtn = document.getElementById("stopBtn");
const statusEl = document.getElementById("status");
const countdownEl = document.getElementById("countdown");

document.querySelectorAll(".sound-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    selectSound(btn.dataset.sound);
    playSound();
  });
});

selectSound(selectedSound);

function formatCountdown(ms) {
  if (ms <= 0) return "0:00";
  const totalSec = Math.ceil(ms / 1000);
  const m = Math.floor(totalSec / 60);
  const s = totalSec % 60;
  return m + ":" + String(s).padStart(2, "0");
}

function updateCountdown() {
  if (!nextDing) return;
  const remaining = nextDing - Date.now();
  countdownEl.textContent = formatCountdown(remaining);
  if (remaining <= 0) countdownEl.textContent = "";
}

function ding() {
  playSound();
  showNotification();
  nextDing = Date.now() + intervalMs;
}

async function start() {
  const minutes = parseFloat(intervalInput.value);
  if (isNaN(minutes) || minutes <= 0) return;
  intervalMs = minutes * 60 * 1000;

  localStorage.setItem("dinger-interval", intervalInput.value);

  // Request notification permission
  if ("Notification" in window && Notification.permission === "default") {
    const perm = await Notification.requestPermission();
    if (perm === "denied") {
      statusEl.textContent = "notifications denied â€” audio only";
    }
  }

  startKeepalive();
  playSound();
  showNotification();

  nextDing = Date.now() + intervalMs;
  timerId = setInterval(ding, intervalMs);
  countdownId = setInterval(updateCountdown, 250);

  startBtn.disabled = true;
  stopBtn.disabled = false;
  intervalInput.disabled = true;
  statusEl.textContent = SOUNDS[selectedSound].label.toLowerCase() + " every " + minutes + " min";
}

function stop() {
  stopKeepalive();
  clearInterval(timerId);
  clearInterval(countdownId);
  timerId = null;
  countdownId = null;
  nextDing = null;
  intervalMs = null;
  startBtn.disabled = false;
  stopBtn.disabled = true;
  intervalInput.disabled = false;
  statusEl.textContent = "";
  countdownEl.textContent = "";
}

// --- Visibility API: catch up after background throttling ---
document.addEventListener("visibilitychange", () => {
  if (document.visibilityState !== "visible" || !timerId || !nextDing) return;
  const now = Date.now();
  if (now >= nextDing) {
    ding();
    clearInterval(timerId);
    timerId = setInterval(ding, intervalMs);
  }
  updateCountdown();
});

startBtn.addEventListener("click", start);
stopBtn.addEventListener("click", stop);
</script>
</body>
</html>
